/**
NovelViewer Template

Copyright (c)2020 Aya Mizushiro

This software is released under the MIT License.
http://opensource.org/licenses/mit-license.php
*/
class SNViwerAppClass{constructor(e){this.indent=!!e&&"indent"in e&&e.indent,this.convert=!e||!("convert"in e)||e.convert,this.return=!!e&&"return"in e&&e.return,this.twitter=!!e&&"twitter"in e&&e.twitter,this.indexList=!!e&&"indexList"in e&&e.indexList,this.touchDevice=this.isTouchDevice(),this.imageUrls="",this.imageLoading=!1,this.wrapper=document.getElementById("app"),this.init()}init(){if(this.insertLoading(),this.fontCheck()&&this.insertFont(),this.createMenu(this.indexList),(this.indent||this.convert)&&(this.imageLoading=this.createNovelBody()),null!=document.getElementById("nvl-title")&&document.getElementById("nvl-title").classList.add("novel-title"),null!=document.getElementById("nvl-subtitle")&&document.getElementById("nvl-subtitle").classList.add("novel-subtitle"),null!=document.getElementById("nvl-section-title")){let e=document.getElementById("nvl-section-title");e.classList.add("section-title");let t=this.createSpanEl("","",e.textContent.trim());e.textContent="",e.appendChild(t)}null!=document.getElementById("novel-body")&&document.getElementById("novel-body").classList.add("novel-block"),this.saveStyleLoad(),this.imageLoading||("rtl"===this.writing&&this.setScrollX(),this.loadingHide())}insertLoading(){let e=this.createDivEl("loading","loader-wrapper"),t=this.createDivEl("","loading");t.appendChild(this.createSpanEl("","","Loading...")),e.appendChild(t),document.body.appendChild(e)}insertFont(){let e=document.createElement("link");e.rel="stylesheet",e.href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap",document.getElementsByTagName("head")[0].appendChild(e),e.href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP&display=swap",document.getElementsByTagName("head")[0].appendChild(e)}createMenu(e){let t=this.createMenuEl("","");this.return&&t.appendChild(this.createAEl("","novel-close-button",this.return,"\xd7閉じる",!1));let l=this.createLabelEl("close-style","menu-close-toggle","novel-style-toggle","close");l.style.display="none",t.appendChild(l);let i=this.createLabelEl("close-index","menu-close-toggle","novel-index-toggle","close");i.style.display="none",t.appendChild(i),t.appendChild(this.createStyleMenu()),0<Object.keys(e).length&&t.appendChild(this.createIndex(e)),this.wrapper.appendChild(t)}createStyleMenu(){let e=this.createDivEl("",""),t=this.craeteCheckboxEl("novel-style-toggle","");t.addEventListener("change",e=>{this.toggleStyle(e)},!1),e.appendChild(t),e.appendChild(this.createLabelEl("","novel-style-toggle-label","novel-style-toggle","スタイル"));let l=this.createDivEl("novel-style-menu","novel-menu"),i=this.createDivEl("","novel-style-contents"),n=this.createDivEl("","menu-item-wrap");n.appendChild(this.createPEl("","menu-item-label","文字サイズ"));let s=this.createDivEl("","novel-radio-wrap"),a=this.createRadioEl("fontsize-small","","fontsize","small");a.addEventListener("change",e=>{this.toggleFontsize(e)},!1),s.appendChild(a),s.appendChild(this.createLabelEl("",["radio-label-style","style-small"],"fontsize-small","小"));let r=this.createRadioEl("fontsize-normal","","fontsize","normal");r.addEventListener("change",e=>{this.toggleFontsize(e)},!1),s.appendChild(r),s.appendChild(this.createLabelEl("",["radio-label-style","style-normal"],"fontsize-normal","中"));let d=this.createRadioEl("fontsize-large","","fontsize","large");d.addEventListener("change",e=>{this.toggleFontsize(e)},!1),s.appendChild(d),s.appendChild(this.createLabelEl("",["radio-label-style","style-large"],"fontsize-large","大"));let h=this.createRadioEl("fontsize-oversize","","fontsize","oversize");h.addEventListener("change",e=>{this.toggleFontsize(e)},!1),s.appendChild(h),s.appendChild(this.createLabelEl("",["radio-label-style","style-oversize"],"fontsize-oversize","特大")),n.appendChild(s),i.appendChild(n);let o=this.createDivEl("","menu-item-wrap");o.appendChild(this.createPEl("","menu-item-label","背景"));let c=this.createDivEl("","novel-radio-wrap"),g=this.createRadioEl("theme-white","","theme","white");g.addEventListener("change",e=>{this.toggleTheme(e)},!1),c.appendChild(g),c.appendChild(this.createLabelEl("",["radio-label-style","style-white"],"theme-white","白"));let p=this.createRadioEl("theme-dark","","theme","dark");p.addEventListener("change",e=>{this.toggleTheme(e)},!1),c.appendChild(p),c.appendChild(this.createLabelEl("",["radio-label-style","style-dark"],"theme-dark","黒"));let m=this.createRadioEl("theme-kinari","","theme","kinari");m.addEventListener("change",e=>{this.toggleTheme(e)},!1),c.appendChild(m),c.appendChild(this.createLabelEl("",["radio-label-style","style-kinari"],"theme-kinari","生成り")),o.appendChild(c),i.appendChild(o);let E=this.createDivEl("","menu-item-wrap");E.appendChild(this.createPEl("","menu-item-label","フォント"));let u=this.createDivEl("","novel-radio-wrap"),y=this.createRadioEl("font-mincho","","font","mincho");y.addEventListener("change",e=>{this.toggleFont(e)},!1),u.appendChild(y),u.appendChild(this.createLabelEl("",["radio-label-style","style-mincho"],"font-mincho","明朝"));let C=this.createRadioEl("font-gothic","","font","gothic");C.addEventListener("change",e=>{this.toggleFont(e)},!1),u.appendChild(C),u.appendChild(this.createLabelEl("",["radio-label-style","style-gothic"],"font-gothic","ゴシック")),E.appendChild(u),i.appendChild(E);let v=this.createDivEl("","menu-item-wrap");v.appendChild(this.createPEl("","menu-item-label","組版"));let f=this.createDivEl("","novel-radio-wrap"),b=this.createRadioEl("write-rtl","","write","rtl");b.addEventListener("change",e=>{this.toggleWriting(e)},!1),f.appendChild(b),f.appendChild(this.createLabelEl("",["radio-label-style","style-rtl"],"write-rtl","縦書き"));let L=this.createRadioEl("write-ltr","","write","ltr");return L.addEventListener("change",e=>{this.toggleWriting(e)},!1),f.appendChild(L),f.appendChild(this.createLabelEl("",["radio-label-style","style-ltr"],"write-ltr","横書き")),v.appendChild(f),i.appendChild(v),l.appendChild(i),e.appendChild(l),e}createIndex(e){let t=this.createDivEl("",""),l=this.craeteCheckboxEl("novel-index-toggle","");l.addEventListener("change",e=>{this.toggleIndex(e)},!1),t.appendChild(l),t.appendChild(this.createLabelEl("","novel-index-toggle-label","novel-index-toggle","目次"));let i=this.createDivEl("novel-index-menu","novel-menu"),n=this.createDivEl("","novel-index-contents");return n.appendChild(this.createPEl("","index-title",this.getTitle())),n.appendChild(this.createPEl("","index-subtitle",this.getSubtitle())),n.appendChild(this.createIndexList(e)),i.appendChild(n),t.appendChild(i),t}createIndexList(e){let t=window.location.href,l=document.createElement("ol");l.setAttribute("id","index-list"),this.addClass(l,"index-list");let i=-1;var n=document.createDocumentFragment();if(Object.keys(e).forEach((l,s)=>{let a=document.createElement("li");t.endsWith(e[l])?(a.appendChild(this.createAEl("","current",e[l],l,!1)),i=s):a.appendChild(this.createAEl("","",e[l],l)),n.appendChild(a)}),l.appendChild(n),0<=i-1){let s=Object.keys(e)[i-1];this.insertHeader(s,e[s])}if(i+1<Object.keys(e).length){let a=Object.keys(e)[i+1];this.insertFooter(a,e[a])}else this.insertFooter(!1,!1);return l}insertHeader(e,t){let l=document.createElement("header");this.addClass(l,"novel-header"),l.appendChild(this.createAEl("","prev-link",t,e,!1)),this.wrapper.insertBefore(l,this.wrapper.firstChild)}insertFooter(e,t){let l=document.createElement("footer");if(this.addClass(l,"novel-footer"),this.twitter){let i=this.createDivEl("","sns-wrap"),n=document.createElement("ul");this.addClass(n,"sns-list");let s=document.createElement("li"),a=window.location.href,r={url:a,text:this.getTitle()+" "+this.getSubtitle()+"\n「"+this.getSectionTitle()+"」\n\n"},d=[];for(let h in r)d[d.length]=encodeURIComponent(h)+"="+encodeURIComponent(r[h]);let o="https://twitter.com/intent/tweet?"+d.join("&");s.appendChild(this.createAEl("",["sns-link","btn-twitter"],o,"Twitter",!0)),n.appendChild(s),i.appendChild(n),l.appendChild(i)}let c=document.createElement("a");e?(this.addClass(c,"next-link"),c.setAttribute("href",t),c.innerText=e,l.appendChild(c)):this.return&&(this.addClass(c,"close-link"),c.setAttribute("href",this.return),c.innerText="閉じる",l.appendChild(c)),this.wrapper.appendChild(l)}saveStyleLoad(){this.addClass(this.wrapper,"novel-wrapper");let e=this.searchLocalStorage("fontsize");this.fontsize=!1!==e?this.getStrage(e):"normal",this.addClass(this.wrapper,"fontsize-"+this.fontsize),document.getElementById("fontsize-"+this.fontsize).checked=!0,e=this.searchLocalStorage("theme"),this.theme=!1!==e?this.getStrage(e):"white",this.addClass(this.wrapper,"paper-"+this.theme),document.getElementById("theme-"+this.theme).checked=!0,e=this.searchLocalStorage("font"),this.font=!1!==e?this.getStrage(e):"mincho",this.addClass(this.wrapper,"font-"+this.font),document.getElementById("font-"+this.font).checked=!0,e=this.searchLocalStorage("writing"),this.writing=!1!==e?this.getStrage(e):"ltr",this.addClass(this.wrapper,this.writing),document.getElementById("write-"+this.writing).checked=!0}searchLocalStorage(e){for(let t=0;t<localStorage.length;t++)if(localStorage.key(t)===e)return localStorage.key(t);return!1}createNovelBody(){let e=document.getElementById("novel-body");0<e.children.length&&this.indent?this.convertIndent(e):this.convert&&this.convertNovelText(e)}convertNovelText(e){let t=e.innerHTML;t=(t=(t=(t=(t=(t=t.replace(/――/g,'<span class="dash-rule">―</span>―')).replace(/\|/g,"｜")).replace(/｜/g,"<ruby><rb>")).replace(/《/g,"</rb><rp>（</rp><rt>")).replace(/》/g,"</rt><rp>）</rp></ruby>")).replace(/(\!\?|\!\!|\?\!|\?\?)/g,'<span class="text-combine">$1</span>');let l=t.split(/\r\n|\n/),i="",n=1;for(let s=0;s<l.length;s++){let a=l[s];a.includes("[")?(i+='<p id="sashie'+n+'"></p>',n++):(this.indent&&(a=this.addIndent(a)),i+="<p>"+a+"</p>")}e.innerHTML=i;let r=this.getImagesUri(l),d=this.createImages(r);return this.insertImageFlags(d),!!d&&0<d.length}createImages(e){this.loadingCount=0;let t=Array(e.length);for(let l=0;l<e.length;l++)t[l]=new Image,t[l].src=e[l],t[l].alt="",t[l].addEventListener("load",()=>{let i=document.getElementById("sashie"+(l+1));t[l].width>t[l].height?t[l].classList.add("dir-v"):t[l].classList.add("dir-h");let n=document.createElement("p");n.appendChild(t[l]),i.parentNode.insertBefore(n,i),i.parentNode.removeChild(i),this.loadingCount++,this.loadingCount===e.length&&("rtl"===this.writing&&this.setScrollX(),this.loadingHide())});return t}convertIndent(e){let t=e.children;for(let l=0;l<t.length;l++){let i=t[l];this.CheckTag(i)&&(i.innerHTML=this.addIndent(i.innerHTML)),e.replaceChild(e.children[l],i)}return!1}addIndent(e){return e=e.trim(),this.firstCharCheck(e)&&(e="　"+e),e}getTitle(){let e=document.getElementById("nvl-title"),t="";for(let l of e.childNodes)"#text"==l.nodeName&&(t+=l.nodeValue);return t.trim()}getSubtitle(){return document.getElementById("nvl-subtitle")?document.getElementById("nvl-subtitle").textContent.trim():""}getSectionTitle(){return document.getElementById("nvl-section-title").textContent.trim()}getImagesUri(e){let t=[];for(let l=0;l<e.length;l++){let i=e[l];i.includes("[")&&t.push(i.replace(/\[|\]/g,""))}return t}insertImageFlags(e){for(let t=0;t<e.length;t++)document.getElementById("sashie"+(t+1)).appendChild(e[t])}loadingHide(){document.getElementById("loading").classList.add("hide")}toggleTheme(e){let t=e.target.value;this.changeClass(this.theme,t,"paper-"),this.theme=t,this.setStrage("theme",t)}toggleFont(e){let t=e.target.value;this.changeClass(this.font,t,"font-"),this.font=t,this.setStrage("font",t)}toggleFontsize(e){let t=document.body.scrollWidth-document.body.offsetWidth,l=window.scrollX,i=e.target.value;if(this.changeClass(this.fontsize,i,"fontsize-"),this.fontsize=i,this.setStrage("fontsize",i),"rtl"!==this.writing)return;let n=document.body.scrollWidth-document.body.offsetWidth;window.scroll(l-(t-n),0)}toggleWriting(e){let t=e.target.value;this.changeClass(this.writing,t,""),this.writing=t,this.setStrage("writing",t),"ltr"===this.writing?this.setScrollY():this.setScrollX()}toggleStyle(e){e.target.checked?document.getElementById("close-style").style.display="block":document.getElementById("close-style").style.display="none"}toggleIndex(e){let t=e.target.checked;t?document.getElementById("close-index").style.display="block":document.getElementById("close-index").style.display="none"}createMenuEl(e,t){let l=document.createElement("menu");return 0<e.length&&l.setAttribute("id",e),0<t.length&&this.addClass(l,t),l}createDivEl(e,t){let l=document.createElement("div");return 0<e.length&&l.setAttribute("id",e),0<t.length&&this.addClass(l,t),l}createPEl(e,t,l){let i=document.createElement("p");return 0<e.length&&i.setAttribute("id",e),0<t.length&&this.addClass(i,t),i.innerText=l,i}createSpanEl(e,t,l){let i=document.createElement("span");return 0<e.length&&i.setAttribute("id",e),0<t.length&&this.addClass(i,t),i.innerText=l,i}createAEl(e,t,l,i,n){let s=document.createElement("a");return 0<e.length&&s.setAttribute("id",e),0<t.length&&this.addClass(s,t),s.href=l,s.innerText=i,n&&s.setAttribute("target","_blank"),s}createLabelEl(e,t,l,i){let n=document.createElement("label");return 0<e.length&&n.setAttribute("id",e),0<t.length&&this.addClass(n,t),0<l.length&&n.setAttribute("for",l),n.innerText=i,n}craeteCheckboxEl(e,t){let l=document.createElement("input");return l.type="checkbox",0<e.length&&l.setAttribute("id",e),0<t.length&&this.addClass(l,t),l}createRadioEl(e,t,l,i){let n=document.createElement("input");return n.type="radio",0<e.length&&n.setAttribute("id",e),0<t.length&&this.addClass(n,t),0<l.length&&n.setAttribute("name",l),n.value=i,n}addClass(e,t){Array.isArray(t)?t.forEach(t=>{e.classList.add(t)}):e.classList.add(t)}changeClass(e,t,l){this.wrapper.classList.remove(l+e),this.wrapper.classList.add(l+t)}setScrollY(){window.scrollY;let e=document.body.scrollWidth-document.body.offsetWidth-window.scrollX;document.body.scrollHeight,document.body.scrollWidth,document.body.offsetWidth,this.touchDevice||window.removeEventListener("wheel",this.scrollyTox,{passive:!1}),window.scroll(0,e)}setScrollX(){let e=window.scrollY;document.body.scrollWidth-document.body.offsetWidth-window.scrollX,document.body.scrollHeight;let t=document.body.scrollWidth-document.body.offsetWidth;this.touchDevice||window.addEventListener("wheel",this.scrollyTox,{passive:!1}),window.scroll(t-e,0)}setStrage(e,t){e&&t?localStorage.setItem(e,t):localStorage.removeItem(e)}getStrage(e){return localStorage.getItem(e)}scrollyTox(e){0===e.deltaX&&(e.stopPropagation(),e.preventDefault(),-1!==window.navigator.userAgent.toLowerCase().indexOf("firefox")?document.getElementById("app").scrollBy(-(10*e.deltaY),0):document.getElementById("app").scrollBy(-e.deltaY,0))}CheckTag(e){switch(e.tagName){case"P":default:return!0;case"IMG":return!1}}firstCharCheck(e){let t=e.trim().substring(0,1);if("「"===t||"（"===t||"『"===t)return!1;let l=e.substring(0,2);return"<i"!==l}isTouchDevice(){var e=!1;return null===window.ontouchstart&&(e=!0),e}fontCheck(){return navigator.userAgent.includes("Android")}}