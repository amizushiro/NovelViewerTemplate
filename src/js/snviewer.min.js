class SNViewerAppClass{constructor(e){this.indent=!!e&&"indent"in e&&e.indent,this.convert=!e||!("convert"in e)||e.convert,this.return=!!e&&"return"in e&&e.return,this.useHtml=!!e&&"useHtml"in e&&e.useHtml,this.useShare=!!e&&"useShare"in e&&e.useShare,this.useGoogleFont=!!e&&"useGoogleFont"in e&&e.useGoogleFont,this.indexList=!!e&&"indexList"in e&&e.indexList,this.touchDevice=this.isTouchDevice(),this.imageUrls="",this.imageLoading=!1,this.wrapper=document.getElementById("snv-app"),this.prefix="snv-",this.init()}init(){if(this.isAndroid()&&!this.useGoogleFont&&this.insertFont(),this.createMenu(this.indexList),(this.indent||this.convert)&&(this.imageLoading=this.createNovelBody()),null!=document.getElementById("nvl-title")){let e=document.getElementById("nvl-title");e.classList.add(this.prefix+"novel-title"),e.innerHTML=this.convertNotation(e.innerHTML)}if(null!=document.getElementById("nvl-subtitle")){let t=document.getElementById("nvl-subtitle");t.classList.add(this.prefix+"novel-subtitle"),t.innerHTML=this.convertNotation(t.innerHTML)}if(null!=document.getElementById("nvl-section-title")){let i=document.getElementById("nvl-section-title");i.classList.add(this.prefix+"section-title");let l=this.createSpanEl("","",i.textContent.trim());i.textContent="",i.appendChild(l),i.innerHTML=this.convertNotation(i.innerHTML)}null!=document.getElementById("novel-body")&&document.getElementById("novel-body").classList.add(this.prefix+"novel-block"),this.saveStyleLoad(),this.imageLoading||this.renderingFinish()}insertFont(){let e=document.createElement("link"),t=document.createElement("link");e.rel="stylesheet",t.rel="stylesheet",t.href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap",document.getElementsByTagName("head")[0].appendChild(t),e.href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP&display=swap",document.getElementsByTagName("head")[0].appendChild(e)}createMenu(e){let t=this.createMenuEl("","menu-wrapper");this.return&&t.appendChild(this.createAEl("","novel-close-button",this.return,"\xd7閉じる",!1));let i=this.createLabelEl("close-style","menu-close-toggle","novel-style-toggle","close");i.style.display="none",t.appendChild(i);let l=this.createLabelEl("close-index","menu-close-toggle","novel-index-toggle","close");l.style.display="none",t.appendChild(l),t.appendChild(this.createStyleMenu()),0<Object.keys(e).length&&t.appendChild(this.createIndex(e)),this.wrapper.appendChild(t)}createStyleMenu(){let e=this.createDivEl("",""),t=this.craeteCheckboxEl("novel-style-toggle","");t.addEventListener("change",e=>{this.toggleStyle(e)},!1),e.appendChild(t),e.appendChild(this.createLabelEl("","novel-style-toggle-label","novel-style-toggle","スタイル"));let i=this.createDivEl("novel-style-menu","novel-menu"),l=this.createDivEl("","novel-style-contents"),s=this.createDivEl("","menu-item-wrap");s.appendChild(this.createPEl("","menu-item-label","文字サイズ"));let n=this.createDivEl("","novel-radio-wrap"),r=this.createRadioEl("fontsize-small","","fontsize","small");r.addEventListener("change",e=>{this.toggleFontsize(e)},!1),n.appendChild(r),n.appendChild(this.createLabelEl("",["radio-label-style","style-small"],"fontsize-small","小"));let a=this.createRadioEl("fontsize-normal","","fontsize","normal");a.addEventListener("change",e=>{this.toggleFontsize(e)},!1),n.appendChild(a),n.appendChild(this.createLabelEl("",["radio-label-style","style-normal"],"fontsize-normal","中"));let h=this.createRadioEl("fontsize-large","","fontsize","large");h.addEventListener("change",e=>{this.toggleFontsize(e)},!1),n.appendChild(h),n.appendChild(this.createLabelEl("",["radio-label-style","style-large"],"fontsize-large","大"));let d=this.createRadioEl("fontsize-oversize","","fontsize","oversize");d.addEventListener("change",e=>{this.toggleFontsize(e)},!1),n.appendChild(d),n.appendChild(this.createLabelEl("",["radio-label-style","style-oversize"],"fontsize-oversize","特大")),s.appendChild(n),l.appendChild(s);let o=this.createDivEl("","menu-item-wrap");o.appendChild(this.createPEl("","menu-item-label","背景"));let c=this.createDivEl("","novel-radio-wrap"),p=this.createRadioEl("theme-white","","theme","white");p.addEventListener("change",e=>{this.toggleTheme(e)},!1),c.appendChild(p),c.appendChild(this.createLabelEl("",["radio-label-style","style-white"],"theme-white","白"));let g=this.createRadioEl("theme-dark","","theme","dark");g.addEventListener("change",e=>{this.toggleTheme(e)},!1),c.appendChild(g),c.appendChild(this.createLabelEl("",["radio-label-style","style-dark"],"theme-dark","黒"));let m=this.createRadioEl("theme-kinari","","theme","kinari");m.addEventListener("change",e=>{this.toggleTheme(e)},!1),c.appendChild(m),c.appendChild(this.createLabelEl("",["radio-label-style","style-kinari"],"theme-kinari","生成り")),o.appendChild(c),l.appendChild(o);let u=this.createDivEl("","menu-item-wrap");u.appendChild(this.createPEl("","menu-item-label","フォント"));let E=this.createDivEl("","novel-radio-wrap"),f=this.createRadioEl("font-mincho","","font","mincho");f.addEventListener("change",e=>{this.toggleFont(e)},!1),E.appendChild(f),E.appendChild(this.createLabelEl("",["radio-label-style","style-mincho"],"font-mincho","明朝"));let v=this.createRadioEl("font-gothic","","font","gothic");v.addEventListener("change",e=>{this.toggleFont(e)},!1),E.appendChild(v),E.appendChild(this.createLabelEl("",["radio-label-style","style-gothic"],"font-gothic","ゴシック")),u.appendChild(E),l.appendChild(u);let y=this.createDivEl("","menu-item-wrap");y.appendChild(this.createPEl("","menu-item-label","組版"));let C=this.createDivEl("","novel-radio-wrap"),b=this.createRadioEl("write-rtl","","write","rtl");b.addEventListener("change",e=>{this.toggleWriting(e)},!1),C.appendChild(b),C.appendChild(this.createLabelEl("",["radio-label-style","style-rtl"],"write-rtl","縦書き"));let x=this.createRadioEl("write-ltr","","write","ltr");return x.addEventListener("change",e=>{this.toggleWriting(e)},!1),C.appendChild(x),C.appendChild(this.createLabelEl("",["radio-label-style","style-ltr"],"write-ltr","横書き")),y.appendChild(C),l.appendChild(y),i.appendChild(l),e.appendChild(i),e}createIndex(e){let t=this.createDivEl("",""),i=this.craeteCheckboxEl("novel-index-toggle","");i.addEventListener("change",e=>{this.toggleIndex(e)},!1),t.appendChild(i),t.appendChild(this.createLabelEl("","novel-index-toggle-label","novel-index-toggle","目次"));let l=this.createDivEl("novel-index-menu","novel-menu"),s=this.createDivEl("","novel-index-contents");return s.appendChild(this.createPEl("","index-title",this.getTitle())),s.appendChild(this.createPEl("","index-subtitle",this.getSubtitle())),s.appendChild(this.createIndexList(e)),l.appendChild(s),t.appendChild(l),t}createIndexList(e){let t=window.location.href,i=document.createElement("ol");i.setAttribute("id",this.prefix+"index-list"),this.addClass(i,"index-list");let l=-1;var s=document.createDocumentFragment();if(Object.keys(e).forEach((i,n)=>{let r=document.createElement("li");t.endsWith(e[i])?(r.appendChild(this.createAEl("","current",e[i],i,!1)),l=n):r.appendChild(this.createAEl("","",e[i],i)),s.appendChild(r)}),i.appendChild(s),0<=l-1){let n=Object.keys(e)[l-1];this.insertHeader(n,e[n])}if(l+1<Object.keys(e).length){let r=Object.keys(e)[l+1];this.insertFooter(r,e[r])}else this.insertFooter(!1,!1);return i}insertHeader(e,t){let i=document.createElement("header");this.addClass(i,"novel-header"),i.appendChild(this.createAEl("","prev-link",t,e,!1)),this.wrapper.insertBefore(i,this.wrapper.firstChild)}insertFooter(e,t){let i=document.createElement("footer");if(this.addClass(i,"novel-footer"),this.useShare){let l=this.createDivEl("","sns-wrap"),s=this.createDivEl("","sns-btn-wrap"),n=this.createBtnEl("","btn-share","シェア","button");s.appendChild(n),l.appendChild(s);let r=window.location.href,a=this.getTitle(),h=""===a?"":a+" ",d=this.getSubtitle(),o=""===d?"":d,c="「"+this.getSectionTitle()+"」\n";if(navigator.canShare)n.addEventListener("click",async()=>{try{await navigator.share({text:h+o+c,url:r})}catch(e){console.log(e)}});else{let p=this.createDivEl("shareArea",["shareTextWrap","hide"]),g=document.createElement("p");g.innerHTML="下記テキストをコピーして、<br>SNSの投稿画面に貼り付けてください。",p.appendChild(g);let m=document.createElement("textarea");m.value=h+o+c+r,m.addEventListener("click",e=>{e.target.select()}),p.appendChild(m);let u=this.createBtnEl("","copyBtn","クリップボードにコピー","button");u.addEventListener("click",()=>{let e=m.value;navigator.clipboard.writeText(e).then(()=>{alert("クリップボードにコピーしました！")},()=>{alert("コピーに失敗しました。お手数ですが、手動でコピーをお願いいたします。")})}),p.appendChild(u),l.appendChild(p),n.addEventListener("click",()=>{p.classList.contains("snv-hide")?p.classList.remove("snv-hide"):p.classList.add("snv-hide")})}i.appendChild(l)}let E=document.createElement("a");e?(this.addClass(E,"next-link"),E.setAttribute("href",t),E.innerText=e,i.appendChild(E)):this.return&&(this.addClass(E,"close-link"),E.setAttribute("href",this.return),E.innerText="閉じる",i.appendChild(E)),this.wrapper.appendChild(i)}saveStyleLoad(){this.addClass(this.wrapper,"novel-wrapper");let e=this.searchLocalStorage("fontsize");this.fontsize=!1!==e&&this.getStrage(e)?this.getStrage(e):"normal",this.addClass(this.wrapper,"fontsize-"+this.fontsize),document.getElementById(this.prefix+"fontsize-"+this.fontsize).checked=!0,e=this.searchLocalStorage("theme"),this.theme=!1!==e&&this.getStrage(e)?this.getStrage(e):"white",this.addClass(this.wrapper,"paper-"+this.theme),document.getElementById(this.prefix+"theme-"+this.theme).checked=!0,e=this.searchLocalStorage("font"),this.font=!1!==e&&this.getStrage(e)?this.getStrage(e):"mincho",this.addClass(this.wrapper,"font-"+this.font),document.getElementById(this.prefix+"font-"+this.font).checked=!0,e=this.searchLocalStorage("writing"),this.writing=!1!==e&&this.getStrage(e)?this.getStrage(e):"ltr",this.addClass(this.wrapper,this.writing),document.getElementById(this.prefix+"write-"+this.writing).checked=!0}searchLocalStorage(e){let t=this.prefix+e;for(let i=0;i<localStorage.length;i++)if(localStorage.key(i)===t)return localStorage.key(i);return!1}createNovelBody(){let e=document.getElementById("novel-body");return this.convertNovelText(e)}convertNovelText(e){let t=e.innerHTML;if(t=this.convertNotation(t),this.useHtml)return e.innerHTML=t,this.indent&&this.convertIndent(e),!1;let i=t.split(/\r\n|\n/),l="",s=1;for(let n=0;n<i.length;n++){let r=i[n];r.includes("[")?(l+='<p id="'+this.prefix+"sashie"+s+'"></p>',s++):(this.indent&&(r=this.addIndent(r)),l+="<p>"+r+"</p>")}e.innerHTML=l;let a=this.getImagesUri(i),h=this.createImages(a);return this.insertImageFlags(h),!!h&&0<h.length}convertNotation(e){return e=(e=(e=(e=(e=(e=e.replace(/[―|−|–|―|－|ー|─]/g,"—")).replace(/(—+)/g,'<span class="'+this.prefix+'dash-rule">$1</span>')).replace(/\|/g,"｜")).replace(/｜/g,"<ruby><rb>")).replace(/《/g,"</rb><rp>（</rp><rt>")).replace(/》/g,"</rt><rp>）</rp></ruby>")}createImages(e){this.loadingCount=0;let t=Array(e.length);for(let i=0;i<e.length;i++)t[i]=new Image,t[i].src=e[i],t[i].alt="",t[i].addEventListener("load",()=>{let l=document.getElementById(this.prefix+"sashie"+(i+1));t[i].width>t[i].height?t[i].classList.add("dir-v"):t[i].classList.add("dir-h");let s=document.createElement("p");s.appendChild(t[i]),l.parentNode.insertBefore(s,l),l.parentNode.removeChild(l),this.loadingCount++,this.loadingCount===e.length&&this.renderingFinish()});return t}convertIndent(e){let t=e.children;for(let i=0;i<t.length;i++){let l=t[i];this.CheckTag(l)&&(l.innerHTML=this.addIndent(l.innerHTML)),e.replaceChild(e.children[i],l)}}addIndent(e){return e=e.trim(),this.firstCharCheck(e)&&(e="　"+e),e}getTitle(){let e=document.getElementById("nvl-title"),t="";for(let i of e.childNodes)"#text"==i.nodeName&&(t+=i.nodeValue);return t.trim()}getSubtitle(){return document.getElementById("nvl-subtitle")?document.getElementById("nvl-subtitle").textContent.trim():""}getSectionTitle(){return document.getElementById("nvl-section-title").textContent.trim()}getImagesUri(e){let t=[];for(let i=0;i<e.length;i++){let l=e[i];l.includes("[")&&t.push(l.replace(/\[|\]/g,""))}return t}insertImageFlags(e){for(let t=0;t<e.length;t++)document.getElementById(this.prefix+"sashie"+(t+1)).appendChild(e[t])}renderingFinish(){"rtl"===this.writing&&this.setScrollX(),this.loadingHide()}loadingHide(){let e=!!document.getElementById(this.prefix+"loading");e&&document.getElementById(this.prefix+"loading").classList.add("hide")}toggleTheme(e){let t=e.target.value;this.changeClass(this.theme,t,"paper-"),this.theme=t,this.setStrage("theme",t)}toggleFont(e){let t=e.target.value;this.changeClass(this.font,t,"font-"),this.font=t,this.setStrage("font",t)}toggleFontsize(e){let t=document.body.scrollWidth-document.body.offsetWidth,i=window.scrollX,l=e.target.value;if(this.changeClass(this.fontsize,l,"fontsize-"),this.fontsize=l,this.setStrage("fontsize",l),"rtl"!==this.writing)return;let s=document.body.scrollWidth-document.body.offsetWidth;window.scroll(i-(t-s),0)}toggleWriting(e){let t=e.target.value;this.changeClass(this.writing,t,""),this.writing=t,this.setStrage("writing",t),"ltr"===this.writing?this.setScrollY():this.setScrollX()}toggleStyle(e){e.target.checked?document.getElementById(this.prefix+"close-style").style.display="block":document.getElementById(this.prefix+"close-style").style.display="none"}toggleIndex(e){let t=e.target.checked;t?document.getElementById(this.prefix+"close-index").style.display="block":document.getElementById(this.prefix+"close-index").style.display="none"}createMenuEl(e,t){let i=document.createElement("menu");return 0<e.length&&i.setAttribute("id",this.prefix+e),0<t.length&&this.addClass(i,t),i}createDivEl(e,t){let i=document.createElement("div");return 0<e.length&&i.setAttribute("id",this.prefix+e),0<t.length&&this.addClass(i,t),i}createPEl(e,t,i){let l=document.createElement("p");return 0<e.length&&l.setAttribute("id",this.prefix+e),0<t.length&&this.addClass(l,t),l.innerText=i,l}createSpanEl(e,t,i){let l=document.createElement("span");return 0<e.length&&l.setAttribute("id",this.prefix+e),0<t.length&&this.addClass(l,t),l.innerText=i,l}createAEl(e,t,i,l,s){let n=document.createElement("a");return 0<e.length&&n.setAttribute("id",this.prefix+e),0<t.length&&this.addClass(n,t),n.href=i,n.innerText=l,s&&(n.setAttribute("target","_blank"),n.setAttribute("rel","noopener noreferrer")),n}createLabelEl(e,t,i,l){let s=document.createElement("label");return 0<e.length&&s.setAttribute("id",this.prefix+e),0<t.length&&this.addClass(s,t),0<i.length&&s.setAttribute("for",this.prefix+i),s.innerText=l,s}craeteCheckboxEl(e,t){let i=document.createElement("input");return i.type="checkbox",0<e.length&&i.setAttribute("id",this.prefix+e),0<t.length&&this.addClass(i,t),i}createRadioEl(e,t,i,l){let s=document.createElement("input");return s.type="radio",0<e.length&&s.setAttribute("id",this.prefix+e),0<t.length&&this.addClass(s,t),0<i.length&&s.setAttribute("name",i),s.value=l,s}createBtnEl(e,t,i,l){let s=document.createElement("button");return 0<e.length&&s.setAttribute("id",this.prefix+e),0<t.length&&this.addClass(s,t),0<i.length&&(s.innerText=i),""===l&&(l="button"),s.setAttribute("type",l),s}addClass(e,t){Array.isArray(t)?t.forEach(t=>{e.classList.add(this.prefix+t)}):e.classList.add(this.prefix+t)}changeClass(e,t,i){this.wrapper.classList.remove(this.prefix+i+e),this.wrapper.classList.add(this.prefix+i+t)}setScrollY(){window.scrollY;let e=document.body.scrollWidth-document.body.offsetWidth-window.scrollX;document.body.scrollHeight,document.body.scrollWidth,document.body.offsetWidth,this.touchDevice||window.removeEventListener("wheel",this.scrollyTox,{passive:!1}),window.scroll(0,e)}setScrollX(){let e=window.scrollY;document.body.scrollWidth-document.body.offsetWidth-window.scrollX,document.body.scrollHeight;let t=document.body.scrollWidth-document.body.offsetWidth;this.touchDevice||window.addEventListener("wheel",this.scrollyTox,{passive:!1}),window.scroll(t-e,0)}setStrage(e,t){e&&t?localStorage.setItem(this.prefix+e,t):localStorage.removeItem(this.prefix+e)}getStrage(e){return localStorage.getItem(e)}scrollyTox(e){0===e.deltaX&&(e.stopPropagation(),e.preventDefault(),-1!==window.navigator.userAgent.toLowerCase().indexOf("firefox")?document.getElementById("snv-app").scrollBy(-(10*e.deltaY),0):document.getElementById("snv-app").scrollBy(-e.deltaY,0))}CheckTag(e){switch(e.tagName){case"P":default:return!0;case"IMG":return!1}}firstCharCheck(e){let t=e.trim().substring(0,1);if("「"===t||"（"===t||"『"===t)return!1;let i=e.substring(0,2);return"<i"!==i}isTouchDevice(){var e=!1;return null===window.ontouchstart&&(e=!0),e}isAndroid(){return navigator.userAgent.includes("Android")}}