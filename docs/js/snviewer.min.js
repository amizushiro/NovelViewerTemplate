/**
NovelViewer SAKURA

Copyright (c)2020 Aya Mizushiro

This software is released under the MIT License.
http://opensource.org/licenses/mit-license.php
*/
class SNViwerAppClass{constructor(e){this.indent=!!(e&&"indent"in e)&&e.indent,this.convert=!(e&&"convert"in e)||e.convert,this.return=!!(e&&"return"in e)&&e.return,this.twitter=!!(e&&"twitter"in e)&&e.twitter,this.indexList=!!(e&&"indexList"in e)&&e.indexList,this.touchDevice=this.isTouchDevice(),this.imageUrls="",this.imageLoading=!1,this.wrapper=document.getElementById("app"),this.init()}init(){if(this.insertLoading(),this.fontCheck()&&this.insertFont(),this.createMenu(this.indexList),(this.indent||this.convert)&&(this.imageLoading=this.createNovelBody()),null!=document.getElementById("nvl-title")&&document.getElementById("nvl-title").classList.add("novel-title"),null!=document.getElementById("nvl-subtitle")&&document.getElementById("nvl-subtitle").classList.add("novel-subtitle"),null!=document.getElementById("nvl-section-title")){const e=document.getElementById("nvl-section-title");e.classList.add("section-title");const t=this.createSpanEl("","",e.textContent.trim());e.textContent="",e.appendChild(t)}null!=document.getElementById("novel-body")&&document.getElementById("novel-body").classList.add("novel-block"),this.saveStyleLoad(),this.imageLoading||("rtl"===this.writing&&this.setScrollX(),this.loadingHide())}insertLoading(){const e=this.createDivEl("loading","loader-wrapper"),t=this.createDivEl("","loading");t.appendChild(this.createSpanEl("","","Loading...")),e.appendChild(t),document.body.appendChild(e)}insertFont(){const e=document.createElement("link");e.rel="stylesheet",e.href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap",document.getElementsByTagName("head")[0].appendChild(e),e.href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP&display=swap",document.getElementsByTagName("head")[0].appendChild(e)}createMenu(e){const t=this.createMenuEl("","");this.return&&t.appendChild(this.createAEl("","novel-close-button",this.return,"×閉じる",!1));const n=this.createLabelEl("close-style","menu-close-toggle","novel-style-toggle","close");n.style.display="none",t.appendChild(n);const i=this.createLabelEl("close-index","menu-close-toggle","novel-index-toggle","close");i.style.display="none",t.appendChild(i),t.appendChild(this.createStyleMenu()),0<Object.keys(e).length&&t.appendChild(this.createIndex(e)),this.wrapper.appendChild(t)}createStyleMenu(){const e=this.createDivEl("",""),t=this.craeteCheckboxEl("novel-style-toggle","");t.addEventListener("change",e=>{this.toggleStyle(e)},!1),e.appendChild(t),e.appendChild(this.createLabelEl("","novel-style-toggle-label","novel-style-toggle","スタイル"));const n=this.createDivEl("novel-style-menu","novel-menu"),i=this.createDivEl("","novel-style-contents"),l=this.createDivEl("","menu-item-wrap");l.appendChild(this.createPEl("","menu-item-label","文字サイズ"));const s=this.createDivEl("","novel-radio-wrap"),a=this.createRadioEl("fontsize-small","","fontsize","small");a.addEventListener("change",e=>{this.toggleFontsize(e)},!1),s.appendChild(a),s.appendChild(this.createLabelEl("",["radio-label-style","style-small"],"fontsize-small","小"));const d=this.createRadioEl("fontsize-normal","","fontsize","normal");d.addEventListener("change",e=>{this.toggleFontsize(e)},!1),s.appendChild(d),s.appendChild(this.createLabelEl("",["radio-label-style","style-normal"],"fontsize-normal","中"));const r=this.createRadioEl("fontsize-large","","fontsize","large");r.addEventListener("change",e=>{this.toggleFontsize(e)},!1),s.appendChild(r),s.appendChild(this.createLabelEl("",["radio-label-style","style-large"],"fontsize-large","大"));const o=this.createRadioEl("fontsize-oversize","","fontsize","oversize");o.addEventListener("change",e=>{this.toggleFontsize(e)},!1),s.appendChild(o),s.appendChild(this.createLabelEl("",["radio-label-style","style-oversize"],"fontsize-oversize","特大")),l.appendChild(s),i.appendChild(l);const h=this.createDivEl("","menu-item-wrap");h.appendChild(this.createPEl("","menu-item-label","背景"));const c=this.createDivEl("","novel-radio-wrap"),g=this.createRadioEl("theme-white","","theme","white");g.addEventListener("change",e=>{this.toggleTheme(e)},!1),c.appendChild(g),c.appendChild(this.createLabelEl("",["radio-label-style","style-white"],"theme-white","白"));const p=this.createRadioEl("theme-dark","","theme","dark");p.addEventListener("change",e=>{this.toggleTheme(e)},!1),c.appendChild(p),c.appendChild(this.createLabelEl("",["radio-label-style","style-dark"],"theme-dark","黒"));const m=this.createRadioEl("theme-kinari","","theme","kinari");m.addEventListener("change",e=>{this.toggleTheme(e)},!1),c.appendChild(m),c.appendChild(this.createLabelEl("",["radio-label-style","style-kinari"],"theme-kinari","生成り")),h.appendChild(c),i.appendChild(h);const u=this.createDivEl("","menu-item-wrap");u.appendChild(this.createPEl("","menu-item-label","フォント"));const E=this.createDivEl("","novel-radio-wrap"),C=this.createRadioEl("font-mincho","","font","mincho");C.addEventListener("change",e=>{this.toggleFont(e)},!1),E.appendChild(C),E.appendChild(this.createLabelEl("",["radio-label-style","style-mincho"],"font-mincho","明朝"));const y=this.createRadioEl("font-gothic","","font","gothic");y.addEventListener("change",e=>{this.toggleFont(e)},!1),E.appendChild(y),E.appendChild(this.createLabelEl("",["radio-label-style","style-gothic"],"font-gothic","ゴシック")),u.appendChild(E),i.appendChild(u);const v=this.createDivEl("","menu-item-wrap");v.appendChild(this.createPEl("","menu-item-label","組版"));const b=this.createDivEl("","novel-radio-wrap"),f=this.createRadioEl("write-rtl","","write","rtl");f.addEventListener("change",e=>{this.toggleWriting(e)},!1),b.appendChild(f),b.appendChild(this.createLabelEl("",["radio-label-style","style-rtl"],"write-rtl","縦書き"));const w=this.createRadioEl("write-ltr","","write","ltr");return w.addEventListener("change",e=>{this.toggleWriting(e)},!1),b.appendChild(w),b.appendChild(this.createLabelEl("",["radio-label-style","style-ltr"],"write-ltr","横書き")),v.appendChild(b),i.appendChild(v),n.appendChild(i),e.appendChild(n),e}createIndex(e){const t=this.createDivEl("",""),n=this.craeteCheckboxEl("novel-index-toggle","");n.addEventListener("change",e=>{this.toggleIndex(e)},!1),t.appendChild(n),t.appendChild(this.createLabelEl("","novel-index-toggle-label","novel-index-toggle","目次"));const i=this.createDivEl("novel-index-menu","novel-menu"),l=this.createDivEl("","novel-index-contents");return l.appendChild(this.createPEl("","index-title",this.getTitle())),l.appendChild(this.createPEl("","index-subtitle",this.getSubtitle())),l.appendChild(this.createIndexList(e)),i.appendChild(l),t.appendChild(i),t}createIndexList(e){const t=window.location.href,n=document.createElement("ol");n.setAttribute("id","index-list"),this.addClass(n,"index-list");let i=-1;var l=document.createDocumentFragment();if(Object.keys(e).forEach((n,s)=>{const a=document.createElement("li");t.endsWith(e[n])?(a.appendChild(this.createAEl("","current",e[n],n,!1)),i=s):a.appendChild(this.createAEl("","",e[n],n)),l.appendChild(a)}),n.appendChild(l),0<=i-1){const t=Object.keys(e)[i-1];this.insertHeader(t,e[t])}if(i+1<Object.keys(e).length){const t=Object.keys(e)[i+1];this.insertFooter(t,e[t])}else this.insertFooter(!1,!1);return n}insertHeader(e,t){const n=document.createElement("header");this.addClass(n,"novel-header"),n.appendChild(this.createAEl("","prev-link",t,e,!1)),this.wrapper.insertBefore(n,this.wrapper.firstChild)}insertFooter(e,t){const n=document.createElement("footer");if(this.addClass(n,"novel-footer"),this.twitter){const e=this.createDivEl("","sns-wrap"),t=document.createElement("ul");this.addClass(t,"sns-list");const i=document.createElement("li"),l={url:window.location.href,text:this.getTitle()+" "+this.getSubtitle()+"\n「"+this.getSectionTitle()+"」\n\n"};let s=[];for(let e in l)s[s.length]=encodeURIComponent(e)+"="+encodeURIComponent(l[e]);const a="https://twitter.com/intent/tweet?"+s.join("&");i.appendChild(this.createAEl("",["sns-link","btn-twitter"],a,"Twitter",!0)),t.appendChild(i),e.appendChild(t),n.appendChild(e)}const i=document.createElement("a");e?(this.addClass(i,"next-link"),i.setAttribute("href",t),i.innerText=e,n.appendChild(i)):this.return&&(this.addClass(i,"close-link"),i.setAttribute("href",this.return),i.innerText="閉じる",n.appendChild(i)),this.wrapper.appendChild(n)}saveStyleLoad(){this.addClass(this.wrapper,"novel-wrapper");let e=this.searchLocalStorage("fontsize");this.fontsize=!1!==e?this.getStrage(e):"normal",this.addClass(this.wrapper,"fontsize-"+this.fontsize),document.getElementById("fontsize-"+this.fontsize).checked=!0,e=this.searchLocalStorage("theme"),this.theme=!1!==e?this.getStrage(e):"white",this.addClass(this.wrapper,"paper-"+this.theme),document.getElementById("theme-"+this.theme).checked=!0,e=this.searchLocalStorage("font"),this.font=!1!==e?this.getStrage(e):"mincho",this.addClass(this.wrapper,"font-"+this.font),document.getElementById("font-"+this.font).checked=!0,e=this.searchLocalStorage("writing"),this.writing=!1!==e?this.getStrage(e):"ltr",this.addClass(this.wrapper,this.writing),document.getElementById("write-"+this.writing).checked=!0}searchLocalStorage(e){for(let t=0;t<localStorage.length;t++)if(localStorage.key(t)===e)return localStorage.key(t);return!1}createNovelBody(){const e=document.getElementById("novel-body");0<e.children.length&&this.indent?this.convertIndent(e):this.convert&&this.convertNovelText(e)}convertNovelText(e){let t=e.innerHTML;const n=(t=(t=(t=(t=(t=t.replace(/――/g,'<span class="dash-rule">―</span>―')).replace(/\|/g,"｜")).replace(/｜/g,"<ruby><rb>")).replace(/《/g,"</rb><rp>（</rp><rt>")).replace(/》/g,"</rt><rp>）</rp></ruby>")).split(/\r\n|\n/);let i="",l=1;for(let e=0;e<n.length;e++){let t=n[e];t.includes("[")?(i+='<p id="sashie'+l+'"></p>',l++):(this.indent&&(t=this.addIndent(t)),i+="<p>"+t+"</p>")}e.innerHTML=i;let s=this.getImagesUri(n);const a=this.createImages(s);return this.insertImageFlags(a),!!(a&&0<a.length)}createImages(e){this.loadingCount=0;let t=new Array(e.length);for(let n=0;n<e.length;n++)t[n]=new Image,t[n].src=e[n],t[n].alt="",t[n].addEventListener("load",()=>{const i=document.getElementById("sashie"+(n+1));t[n].width>t[n].height?t[n].classList.add("dir-v"):t[n].classList.add("dir-h");const l=document.createElement("p");l.appendChild(t[n]),i.parentNode.insertBefore(l,i),i.parentNode.removeChild(i),this.loadingCount++,this.loadingCount===e.length&&("rtl"===this.writing&&this.setScrollX(),this.loadingHide())});return t}convertIndent(e){let t=e.children;for(let n=0;n<t.length;n++){const i=t[n];this.CheckTag(i)&&(i.innerHTML=this.addIndent(i.innerHTML)),e.replaceChild(e.children[n],i)}return!1}addIndent(e){return e=e.trim(),this.firstCharCheck(e)&&(e="　"+e),e}getTitle(){const e=document.getElementById("nvl-title");let t="";for(let n of e.childNodes)"#text"==n.nodeName&&(t+=n.nodeValue);return t.trim()}getSubtitle(){return document.getElementById("nvl-subtitle")?document.getElementById("nvl-subtitle").textContent.trim():""}getSectionTitle(){return document.getElementById("nvl-section-title").textContent.trim()}getImagesUri(e){let t=new Array;for(let n=0;n<e.length;n++){let i=e[n];i.includes("[")&&t.push(i.replace(/\[|\]/g,""))}return t}insertImageFlags(e){for(let t=0;t<e.length;t++){document.getElementById("sashie"+(t+1)).appendChild(e[t])}}loadingHide(){document.getElementById("loading").classList.add("hide")}toggleTheme(e){const t=e.target.value;this.changeClass(this.theme,t,"paper-"),this.theme=t,this.setStrage("theme",t)}toggleFont(e){const t=e.target.value;this.changeClass(this.font,t,"font-"),this.font=t,this.setStrage("font",t)}toggleFontsize(e){const t=document.body.scrollWidth-document.body.offsetWidth,n=window.scrollX,i=e.target.value;if(this.changeClass(this.fontsize,i,"fontsize-"),this.fontsize=i,this.setStrage("fontsize",i),"rtl"!==this.writing)return;const l=n-(t-(document.body.scrollWidth-document.body.offsetWidth));window.scroll(l,0)}toggleWriting(e){const t=e.target.value;this.changeClass(this.writing,t,""),this.writing=t,this.setStrage("writing",t),"ltr"===this.writing?this.setScrollY():this.setScrollX()}toggleStyle(e){let t=e.target.checked;document.getElementById("close-style").style.display=t?"block":"none"}toggleIndex(e){const t=e.target.checked;document.getElementById("close-index").style.display=t?"block":"none"}createMenuEl(e,t){const n=document.createElement("menu");return 0<e.length&&n.setAttribute("id",e),0<t.length&&this.addClass(n,t),n}createDivEl(e,t){const n=document.createElement("div");return 0<e.length&&n.setAttribute("id",e),0<t.length&&this.addClass(n,t),n}createPEl(e,t,n){const i=document.createElement("p");return 0<e.length&&i.setAttribute("id",e),0<t.length&&this.addClass(i,t),i.innerText=n,i}createSpanEl(e,t,n){const i=document.createElement("span");return 0<e.length&&i.setAttribute("id",e),0<t.length&&this.addClass(i,t),i.innerText=n,i}createAEl(e,t,n,i,l){const s=document.createElement("a");return 0<e.length&&s.setAttribute("id",e),0<t.length&&this.addClass(s,t),s.href=n,s.innerText=i,l&&s.setAttribute("target","_blank"),s}createLabelEl(e,t,n,i){const l=document.createElement("label");return 0<e.length&&l.setAttribute("id",e),0<t.length&&this.addClass(l,t),0<n.length&&l.setAttribute("for",n),l.innerText=i,l}craeteCheckboxEl(e,t){const n=document.createElement("input");return n.type="checkbox",0<e.length&&n.setAttribute("id",e),0<t.length&&this.addClass(n,t),n}createRadioEl(e,t,n,i){const l=document.createElement("input");return l.type="radio",0<e.length&&l.setAttribute("id",e),0<t.length&&this.addClass(l,t),0<n.length&&l.setAttribute("name",n),l.value=i,l}addClass(e,t){Array.isArray(t)?t.forEach(t=>{e.classList.add(t)}):e.classList.add(t)}changeClass(e,t,n){this.wrapper.classList.remove(n+e),this.wrapper.classList.add(n+t)}setScrollY(){window.scrollY;const e=document.body.scrollWidth-document.body.offsetWidth-window.scrollX;document.body.scrollHeight,document.body.scrollWidth,document.body.offsetWidth;this.touchDevice||window.removeEventListener("wheel",this.scrollyTox,{passive:!1}),window.scroll(0,e)}setScrollX(){const e=window.scrollY,t=(document.body.scrollWidth,document.body.offsetWidth,window.scrollX,document.body.scrollHeight,document.body.scrollWidth-document.body.offsetWidth);this.touchDevice||window.addEventListener("wheel",this.scrollyTox,{passive:!1}),window.scroll(t-e,0)}setStrage(e,t){e&&t?localStorage.setItem(e,t):localStorage.removeItem(e)}getStrage(e){return localStorage.getItem(e)}scrollyTox(e){0===e.deltaX&&(e.stopPropagation(),e.preventDefault(),-1!==window.navigator.userAgent.toLowerCase().indexOf("firefox")?document.getElementById("app").scrollBy(10*-e.deltaY,0):document.getElementById("app").scrollBy(-e.deltaY,0))}CheckTag(e){switch(e.tagName){case"P":return!0;case"IMG":return!1;default:return!0}}firstCharCheck(e){const t=e.trim().substring(0,1);return"「"!==t&&("（"!==t&&("『"!==t&&"<i"!==e.substring(0,2)))}isTouchDevice(){var e=!1;return null===window.ontouchstart&&(e=!0),e}fontCheck(){return navigator.userAgent.includes("Android")}}